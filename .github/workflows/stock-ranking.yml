name: NASDAQ-100 Stock Rankings Update
on:
  schedule:
    # å¹³æ—¥ã®æ—¥æœ¬æ™‚é–“18:00 (UTC 09:00)ã«å®Ÿè¡Œ
    - cron: '0 9 * * 1-5'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå°‘æ•°éŠ˜æŸ„ã§å®Ÿè¡Œï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-nasdaq-rankings:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # NASDAQ-100ã®ã¿ãªã®ã§æ™‚é–“çŸ­ç¸®
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-nasdaq-only-${{ hashFiles('**/requirements.txt') }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas yfinance numpy
        
    - name: Create data directory
      run: mkdir -p data
      
    - name: Run NASDAQ-100 ranking analysis
      id: run-analysis
      env:
        GITHUB_ACTIONS: true
        TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
      run: |
        echo "Starting NASDAQ-100 ranking analysis..."
        echo "Current directory: $(pwd)"
        echo "TEST_MODE: $TEST_MODE"
        start_time=$(date +%s)
        
        # ç¾åœ¨ã®TEST_MODEè¨­å®šã‚’ç¢ºèª
        echo "=== Python file TEST_MODE before modification ==="
        grep -n "TEST_MODE" stock_ranking.py || echo "TEST_MODE not found"
        
        # TEST_MODEã®è¨­å®šã‚’Pythonãƒ•ã‚¡ã‚¤ãƒ«ã«åæ˜ 
        if [ "$TEST_MODE" = "true" ]; then
          sed -i 's/TEST_MODE = False/TEST_MODE = True/' stock_ranking.py
          echo "âœ… ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­..."
        else
          sed -i 's/TEST_MODE = True/TEST_MODE = False/' stock_ranking.py
          echo "âœ… æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­..."
        fi
        
        # ä¿®æ­£å¾Œã®TEST_MODEè¨­å®šã‚’ç¢ºèª
        echo "=== Python file TEST_MODE after modification ==="
        grep -n "TEST_MODE" stock_ranking.py || echo "TEST_MODE not found"
        
        # dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®çŠ¶æ…‹ç¢ºèª
        echo "=== Data directory before execution ==="
        ls -la data/ || echo "Data directory is empty or doesn't exist"
        
        # Pythonå®Ÿè¡Œ
        echo "=== Starting Python execution ==="
        python stock_ranking.py
        python_exit_code=$?
        echo "Python exit code: $python_exit_code"
        
        # dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®çŠ¶æ…‹ç¢ºèªï¼ˆå®Ÿè¡Œå¾Œï¼‰
        echo "=== Data directory after execution ==="
        ls -la data/
        
        # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚ç¢ºèª
        echo "=== Current directory contents ==="
        find . -name "*.json" -type f | head -10
        
        end_time=$(date +%s)
        execution_time=$((end_time - start_time))
        echo "execution_time=$execution_time" >> $GITHUB_OUTPUT
        
        # å®Ÿè¡Œçµæžœã‚’ç¢ºèª
        if [ -f "data/stock_rankings_nasdaq_only.json" ] || [ -f "data/stock_rankings_nasdaq_only_test.json" ]; then
          echo "nasdaq_success=true" >> $GITHUB_OUTPUT
          echo "âœ… NASDAQ-100ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”Ÿæˆå®Œäº†"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚‚ç¢ºèª
          if [ -f "data/stock_rankings_nasdaq_only.json" ]; then
            echo "=== Content preview: stock_rankings_nasdaq_only.json ==="
            head -20 "data/stock_rankings_nasdaq_only.json"
          fi
          
          if [ -f "data/stock_rankings_nasdaq_only_test.json" ]; then
            echo "=== Content preview: stock_rankings_nasdaq_only_test.json ==="
            head -20 "data/stock_rankings_nasdaq_only_test.json"
          fi
        else
          echo "nasdaq_success=false" >> $GITHUB_OUTPUT
          echo "âŒ NASDAQ-100ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”Ÿæˆå¤±æ•—"
          
          # ã‚¨ãƒ©ãƒ¼è©³ç´°èª¿æŸ»
          echo "=== Error Investigation ==="
          echo "Python exit code: $python_exit_code"
          echo "Files in data directory:"
          ls -la data/ || echo "No data directory"
          echo "All JSON files in workspace:"
          find . -name "*.json" -type f || echo "No JSON files found"
          
          exit 1
        fi
        
    - name: Upload results as artifact
      uses: actions/upload-artifact@v4  # v4ã«æ›´æ–°
      with:
        name: nasdaq-rankings-${{ github.run_number }}
        path: data/
        retention-days: 30
        compression-level: 6  # åœ§ç¸®ãƒ¬ãƒ™ãƒ«æŒ‡å®š
        
    - name: Commit and push results
      if: github.event_name == 'schedule' && steps.run-analysis.outputs.nasdaq_success == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action (NASDAQ-100 Auto Update)"
        
        # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ã‚³ãƒŸãƒƒãƒˆ
        if [ -f "data/stock_rankings_nasdaq_only.json" ]; then
          git add data/stock_rankings_nasdaq_only.json
        fi
        
        if [ -f "data/rankings_history.json" ]; then
          git add data/rankings_history.json
        fi
        
        # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
        if ! git diff --staged --quiet; then
          git commit -m "ðŸ”„ Update NASDAQ-100 rankings - $(date '+%Y-%m-%d %H:%M:%S JST')"
          git push
          echo "âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«æ›´æ–°ã—ã¾ã—ãŸ"
        else
          echo "â„¹ï¸ å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create execution summary
      if: always()
      run: |
        echo "## ðŸ“Š NASDAQ-100 Stock Rankings Update Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ å®Ÿè¡Œæƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ™‚é–“**: ${{ steps.run-analysis.outputs.execution_time || 'N/A' }} ç§’" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰**: ${{ github.event.inputs.test_mode || 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“ˆ å‡¦ç†çµæžœ" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.run-analysis.outputs.nasdaq_success }}" = "true" ]; then
          echo "- **NASDAQ-100**: âœ… æ­£å¸¸ã«å‡¦ç†å®Œäº†" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºæƒ…å ±ã‚’è¿½åŠ 
          if [ -f "data/stock_rankings_nasdaq_only.json" ]; then
            file_size=$(du -h data/stock_rankings_nasdaq_only.json | cut -f1)
            echo "- **å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«**: âœ… stock_rankings_nasdaq_only.json ($file_size)" >> $GITHUB_STEP_SUMMARY
          elif [ -f "data/stock_rankings_nasdaq_only_test.json" ]; then
            file_size=$(du -h data/stock_rankings_nasdaq_only_test.json | cut -f1)
            echo "- **å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«**: âœ… stock_rankings_nasdaq_only_test.json ($file_size)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "data/rankings_history.json" ]; then
            history_size=$(du -h data/rankings_history.json | cut -f1)
            echo "- **å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«**: âœ… rankings_history.json ($history_size)" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- **NASDAQ-100**: âŒ å‡¦ç†å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          echo "- **å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«**: âŒ ç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ è»½é‡åŒ–åŠ¹æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- **å¯¾è±¡éŠ˜æŸ„**: NASDAQ-100ã®ã¿ï¼ˆç´„100éŠ˜æŸ„ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- **å‡¦ç†æ™‚é–“çŸ­ç¸®**: S&P500é™¤å¤–ã«ã‚ˆã‚Šå¤§å¹…ãªé«˜é€ŸåŒ–" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡**: ç´„80%å‰Šæ¸›" >> $GITHUB_STEP_SUMMARY
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "## âš ï¸ NASDAQ-100 Rankings Update Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ› ã‚¨ãƒ©ãƒ¼æƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "- **å¤±æ•—ã—ãŸå‡¦ç†**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ­ã‚°ã‚’ç¢ºèª**: GitHub Actions ã®è©³ç´°ãƒ­ã‚°ã‚’å‚ç…§ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ æŽ¨å¥¨å¯¾å‡¦æ³•" >> $GITHUB_STEP_SUMMARY
        echo "1. Yahoo Finance APIã®ä¸€æ™‚çš„ãªå•é¡Œã®å¯èƒ½æ€§ â†’ æ•°æ™‚é–“å¾Œã«æ‰‹å‹•å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æŽ¥ç¶šã®å•é¡Œ â†’ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å†å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "3. ç¶™ç¶šçš„ãªå¤±æ•—ã®å ´åˆ â†’ Issueä½œæˆã—ã¦ã‚³ãƒ¼ãƒ‰ç¢ºèª"  >> $GITHUB_STEP_SUMMARY
